<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Metrics Dashboard</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header>
            <h1>Streaming Metrics Dashboard</h1>
            <div class="time-controls">
                <label for="time-range">Time Range:</label>
                <select id="time-range">
                    <option value="1h">Last Hour</option>
                    <option value="6h">Last 6 Hours</option>
                    <option value="24h" selected>Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
                <button id="refresh-btn">Refresh</button>
            </div>
        </header>

        <div class="dashboard-content">
            <div class="metrics-summary">
                <div class="metric-card">
                    <h3>Active Connections</h3>
                    <div class="metric-value" id="active-connections">0</div>
                </div>
                <div class="metric-card">
                    <h3>Total Bandwidth</h3>
                    <div class="metric-value" id="total-bandwidth">0 MB/s</div>
                </div>
                <div class="metric-card">
                    <h3>Server Load</h3>
                    <div class="metric-value" id="server-load">0%</div>
                </div>
                <div class="metric-card">
                    <h3>Active Streams</h3>
                    <div class="metric-value" id="active-streams">0</div>
                </div>
            </div>

            <div class="chart-row">
                <div class="chart-container">
                    <h3>Connection History</h3>
                    <canvas id="connections-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Bandwidth Usage</h3>
                    <canvas id="bandwidth-chart"></canvas>
                </div>
            </div>

            <div class="chart-row">
                <div class="chart-container">
                    <h3>Server Resources</h3>
                    <canvas id="resources-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Stream Quality</h3>
                    <canvas id="quality-chart"></canvas>
                </div>
            </div>

            <div class="metrics-table">
                <h3>Popular Media</h3>
                <table id="popular-media-table">
                    <thead>
                        <tr>
                            <th>Media</th>
                            <th>Views</th>
                            <th>Unique Viewers</th>
                            <th>Avg. Watch Time</th>
                            <th>Avg. Quality</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const timeRange = document.getElementById('time-range');
            const refreshBtn = document.getElementById('refresh-btn');
            
            let connectionsChart = null;
            let bandwidthChart = null;
            let resourcesChart = null;
            let qualityChart = null;
            
            function fetchDashboardData() {
                const range = timeRange.value;
                let hours = 24;
                
                if (range === '1h') hours = 1;
                else if (range === '6h') hours = 6;
                else if (range === '24h') hours = 24;
                else if (range === '7d') hours = 24 * 7;
                else if (range === '30d') hours = 24 * 30;
                
                fetch(`/api/metrics/dashboard?hours=${hours}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            updateDashboard(data);
                        } else {
                            console.error('Error fetching dashboard data:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching dashboard data:', error);
                    });
            }
            
            function updateDashboard(data) {
                updateSummaryMetrics(data.server);
                updateConnectionsChart(data.server.timeline);
                updateBandwidthChart(data.server.timeline);
                updateResourcesChart(data.server.timeline);
                updatePopularMedia(data.popular_media);
            }
            
            function updateSummaryMetrics(serverData) {
                document.getElementById('active-connections').textContent = 
                    serverData.connections.current || 0;
                
                document.getElementById('total-bandwidth').textContent = 
                    `${(serverData.bandwidth.current || 0).toFixed(2)} MB/s`;
                
                document.getElementById('server-load').textContent = 
                    `${(serverData.system.cpu_avg || 0).toFixed(1)}%`;
                
                document.getElementById('active-streams').textContent = 
                    serverData.streams?.active || 0;
            }
            
            function updateConnectionsChart(timeline) {
                const canvas = document.getElementById('connections-chart');
                const ctx = canvas.getContext('2d');
                
                const labels = timeline.map(point => {
                    const date = new Date(point.timestamp);
                    return date.toLocaleTimeString();
                });
                
                const data = timeline.map(point => point.connections);
                
                if (connectionsChart) {
                    connectionsChart.data.labels = labels;
                    connectionsChart.data.datasets[0].data = data;
                    connectionsChart.update();
                } else {
                    connectionsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Active Connections',
                                data: data,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Connections'
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            function updateBandwidthChart(timeline) {
                const canvas = document.getElementById('bandwidth-chart');
                const ctx = canvas.getContext('2d');
                
                const labels = timeline.map(point => {
                    const date = new Date(point.timestamp);
                    return date.toLocaleTimeString();
                });
                
                const data = timeline.map(point => point.bandwidth);
                
                if (bandwidthChart) {
                    bandwidthChart.data.labels = labels;
                    bandwidthChart.data.datasets[0].data = data;
                    bandwidthChart.update();
                } else {
                    bandwidthChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Bandwidth (MB/s)',
                                data: data,
                                borderColor: 'rgb(153, 102, 255)',
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'MB/s'
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            function updateResourcesChart(timeline) {
                const canvas = document.getElementById('resources-chart');
                const ctx = canvas.getContext('2d');
                
                const labels = timeline.map(point => {
                    const date = new Date(point.timestamp);
                    return date.toLocaleTimeString();
                });
                
                const cpuData = timeline.map(point => point.cpu);
                
                if (resourcesChart) {
                    resourcesChart.data.labels = labels;
                    resourcesChart.data.datasets[0].data = cpuData;
                    resourcesChart.update();
                } else {
                    resourcesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'CPU Usage (%)',
                                data: cpuData,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Percentage (%)'
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            function updatePopularMedia(mediaData) {
                const tableBody = document.querySelector('#popular-media-table tbody');
                
                if (!mediaData || mediaData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
                    return;
                }
                
                let html = '';
                mediaData.forEach(media => {
                    html += `
                        <tr>
                            <td>${media.media_id || 'Unknown'}</td>
                            <td>${media.views || 0}</td>
                            <td>${media.unique_viewers || 0}</td>
                            <td>${formatDuration(media.avg_watch_time || 0)}</td>
                            <td>${media.avg_quality || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
            }
            
            function formatDuration(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
            
            refreshBtn.addEventListener('click', fetchDashboardData);
            
            fetchDashboardData();
            setInterval(fetchDashboardData, 60000);
        });
    </script>
</body>
</html>